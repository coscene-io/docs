"use strict";(self.webpackChunk_coscene_io_docs=self.webpackChunk_coscene_io_docs||[]).push([["1119"],{14336:function(e,t,s){s.r(t),s.d(t,{metadata:()=>n,default:()=>p,frontMatter:()=>o,contentTitle:()=>c,toc:()=>l,assets:()=>a});var n=JSON.parse('{"id":"viz/panel/user-scripts","title":"User Scripts panel","description":"User scripts are custom in-app scripts (written in TypeScript) that transform messages. A user script can transform both playback and range-loaded. The result is output to a new topic.","source":"@site/i18n/en/docusaurus-plugin-content-docs/current/viz/4-panel/10-user-scripts.md","sourceDirName":"viz/4-panel","slug":"/viz/panel/user-scripts","permalink":"/docs/viz/panel/user-scripts","draft":false,"unlisted":false,"tags":[],"version":"current","lastUpdatedBy":"Qi He","lastUpdatedAt":1764068844000,"sidebarPosition":10,"frontMatter":{"sidebar_position":10},"sidebar":"tutorialSidebar","previous":{"title":"Raw Messages","permalink":"/docs/viz/panel/raw-messages"},"next":{"title":"Moments","permalink":"/docs/viz/create-moment-viz"}}'),r=s(25105),i=s(81659);let o={sidebar_position:10},c="User Scripts panel",a={},l=[{value:"Getting started",id:"getting-started",level:2},{value:"Writing your first script",id:"writing-your-first-script",level:3},{value:"Using multiple input topics",id:"using-multiple-input-topics",level:3},{value:"Using global variables",id:"using-global-variables",level:3},{value:"Debugging",id:"debugging",level:3},{value:"Skipping output",id:"skipping-output",level:3},{value:"Using @foxglove/schemas",id:"using-foxgloveschemas",level:3},{value:"Utilities and templates",id:"utilities-and-templates",level:2},{value:"Settings",id:"settings",level:2},{value:"Controls and shortcuts",id:"controls-and-shortcuts",level:2},{value:"TypeScript Resources",id:"typescript-resources",level:2},{value:"When to use a user script or a topic converter extension",id:"when-to-use-a-user-script-or-a-topic-converter-extension",level:2}];function d(e){let t={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(t.header,{children:(0,r.jsx)(t.h1,{id:"user-scripts-panel",children:"User Scripts panel"})}),"\n",(0,r.jsx)(t.p,{children:"User scripts are custom in-app scripts (written in TypeScript) that transform messages. A user script can transform both playback and range-loaded. The result is output to a new topic."}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:["Playback data \u2013 Messages streaming frame-by-frame into Foxglove; e.g. data for the ",(0,r.jsx)(t.a,{href:"/docs/viz/panel/raw-messages",children:"Raw Messages"})," or ",(0,r.jsx)(t.a,{href:"/docs/viz/panel/3d-panel",children:"3D panel"})]}),"\n",(0,r.jsxs)(t.li,{children:["Range-loaded data \u2013 Messages for the entire data range being played back; e.g. data for the ",(0,r.jsx)(t.a,{href:"/docs/viz/panel/plot-panel",children:"Plot"})," or State Transitions panels"]}),"\n"]}),"\n",(0,r.jsx)(t.p,{children:"When transforming range-loaded data, Foxglove creates two instances of the running user script \u2013 one handles the full data range, while the other handles just the current playback frame of messages. Each instance of the user script receives the messages in log time order."}),"\n",(0,r.jsxs)(t.blockquote,{children:["\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.strong,{children:"Tip"})}),"\n",(0,r.jsxs)(t.p,{children:["User scripts are local to a layout. Use a ",(0,r.jsx)(t.a,{href:"/docs/viz/extensions/introduction#message-converters",children:"message converter"})," to transform messages in a way that will apply to all layouts."]}),"\n"]}),"\n",(0,r.jsx)(t.h2,{id:"getting-started",children:"Getting started"}),"\n",(0,r.jsx)(t.p,{children:"User Scripts are written in TypeScript."}),"\n",(0,r.jsxs)(t.blockquote,{children:["\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.strong,{children:"Info"})}),"\n",(0,r.jsx)(t.p,{children:"TypeScript is a superset of JavaScript, so you can Google syntactic questions (e.g. how to manipulate arrays, or access object properties) using JavaScript terms, and semantic questions (e.g. how to make an object property optional) using TypeScript terms."}),"\n"]}),"\n",(0,r.jsx)(t.h3,{id:"writing-your-first-script",children:"Writing your first script"}),"\n",(0,r.jsx)(t.p,{children:"Every script must declare 3 exports:"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.code,{children:"inputs"})," \u2013 An array of input topics to transform"]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.code,{children:"output"})," \u2013 Name of the transformed output topic"]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.code,{children:"script"})," \u2013 A function that takes messages from input topics, transforms them, and then publishes messages on the output topic; must be the ",(0,r.jsx)(t.a,{href:"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/export#description",children:"default export"})]}),"\n"]}),"\n",(0,r.jsxs)(t.p,{children:["Here is a basic script that echoes its input on a new output topic, ",(0,r.jsx)(t.code,{children:"/coscene_script/echo"}),":"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-typescript",children:'import { Input, Message } from "./types";\n\n\nexport const inputs = ["/rosout"];\nexport const output = "/coscene_script/echo";\n\n\nexport default function script(event: Input<"/rosout">): Message<"rosgraph_msgs/Log"> {\n  return event.message;\n}\n'})}),"\n",(0,r.jsxs)(t.p,{children:["If you open a recording with a ",(0,r.jsx)(t.code,{children:"/rosout"})," topic, you can now inspect the ",(0,r.jsx)(t.code,{children:"/studio_script/echo"})," topic in the ",(0,r.jsx)(t.a,{href:"/docs/viz/panel/raw-messages",children:"Raw Messages panel"}),"."]}),"\n",(0,r.jsx)(t.p,{children:"When you create a new script, you\u2019ll be presented with some boilerplate:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-typescript",children:'import { Input, Message } from "./types";\n\ntype Output = { hello: string };\n\nexport const inputs = ["/input/topic"];\nexport const output = "/studio_script/output_topic";\n\nexport default function script(event: Input<"/input/topic">): Output {\n  return { hello: "world!" };\n}\n'})}),"\n",(0,r.jsx)(t.p,{children:"You\u2019ll notice a few things:"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:["The ",(0,r.jsx)(t.code,{children:"Input"})," and ",(0,r.jsx)(t.code,{children:"Message"})," types are imported from the ",(0,r.jsx)(t.code,{children:"./types"})," module, which provides helper types for your Input events and messages"]}),"\n",(0,r.jsxs)(t.li,{children:["The ",(0,r.jsx)(t.code,{children:"Output"})," type has some default properties that the ",(0,r.jsx)(t.code,{children:"script"})," function's output must adhere to"]}),"\n"]}),"\n",(0,r.jsxs)(t.p,{children:[(0,r.jsx)(t.code,{children:"Input"})," is a generic type, meaning that it takes a parameter in order to be used. It is left empty on purpose as you'll need to populate it with the name of your input topic, e.g. ",(0,r.jsx)(t.code,{children:'Input<"/rosout">'}),"."]}),"\n",(0,r.jsxs)(t.blockquote,{children:["\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.strong,{children:"Note"})}),"\n",(0,r.jsx)(t.p,{children:"The input event is read-only. Do not modify the event object."}),"\n"]}),"\n",(0,r.jsxs)(t.p,{children:["As for the ",(0,r.jsx)(t.code,{children:"Output"})," type, you can either manually type out your output with the properties you care about (i.e. what is available in the boilerplate) or use one of the dynamically generated types from the ",(0,r.jsx)(t.code,{children:"Message"})," type imported above. For instance, if you want to publish an array of markers, you can return the type ",(0,r.jsx)(t.code,{children:'Message<"visualization_msgs/MarkerArray">'}),"."]}),"\n",(0,r.jsxs)(t.p,{children:["It's not always obvious how message properties affect the visualized output \u2013 strictly typing your scripts helps you debug issues at compile time rather than at runtime. With that said, you can disable Typescript checks when working on a rough draft of your script by adding ",(0,r.jsx)(t.code,{children:"// @ts-expect-error"})," on the line above the one you want to ignore."]}),"\n",(0,r.jsx)(t.h3,{id:"using-multiple-input-topics",children:"Using multiple input topics"}),"\n",(0,r.jsx)(t.p,{children:"In some cases, you will want to define multiple input topics:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-typescript",children:'import { Input, Message } from "./types";\n\nexport const inputs = ["/rosout", "/tf"];\nexport const output = "/coscene_script/echo";\n\nexport default function script(event: Input<"/rosout"> | Input<"/tf">): { data: number[] } {\n  if (event.topic === "/rosout") {\n    // read event.message fields expected for /rosout messages\n  } else {\n    // read event.message fields expected for /tf messages\n  }\n\n  return { data: [] };\n}\n'})}),"\n",(0,r.jsxs)(t.p,{children:["This snippet uses union types to assert that the message in the ",(0,r.jsx)(t.code,{children:"script"})," function can take either a ",(0,r.jsx)(t.code,{children:"/rosout"})," or ",(0,r.jsx)(t.code,{children:"/tf"})," topic. Use an if/else clause to differentiate between incoming topics' schema names when manipulating messages."]}),"\n",(0,r.jsxs)(t.p,{children:["To combine messages from multiple topics, create a variable in your script's global scope to reference every time your ",(0,r.jsx)(t.code,{children:"script"})," function is invoked. Check timestamps to make sure you are not publishing out-of-sync data."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-typescript",children:'import { Input, Message, Time } from "./types";\n\nexport const inputs = ["/rosout", "/tf"];\nexport const output = "/coscene_script/echo";\n\nlet lastReceiveTime: Time = { sec: 0, nsec: 0 };\nconst myScope: { tf?: Message<"tf2_msgs/TFMessage">; rosout?: Message<"rosgraph_msgs/Log"> } = {};\n\nexport default function script(\n  event: Input<"/rosout"> | Input<"/tf">,\n): { data: number[] } | undefined {\n  const { receiveTime } = message;\n  let inSync = true;\n\n  if (receiveTime.sec !== lastReceiveTime.sec || receiveTime.nsec !== lastReceiveTime.nsec) {\n    lastReceiveTime = receiveTime;\n    inSync = false;\n  }\n\n  if (message.topic === "/rosout") {\n    myScope.rosout = event.message;\n  } else {\n    myScope.tf = event.message;\n  }\n\n  if (!inSync) {\n    return { data: [] };\n  }\n}\n'})}),"\n",(0,r.jsx)(t.h3,{id:"using-global-variables",children:"Using global variables"}),"\n",(0,r.jsxs)(t.p,{children:["The ",(0,r.jsx)(t.code,{children:"script"})," function will receive all of the variables as an object every time it is called. Each time a new message is received, the ",(0,r.jsx)(t.code,{children:"script"})," function will be re-run with the latest variable values:"]}),"\n",(0,r.jsxs)(t.blockquote,{children:["\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.strong,{children:"Note"})}),"\n",(0,r.jsx)(t.p,{children:"Global variables are read-only on user-scripts. Do not modify the globalVars parameter."}),"\n"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-typescript",children:'import { Input, Message } from "./types";\n\ntype Output = {};\ntype GlobalVariables = { someNumericaVar: number };\n\nexport const inputs = [];\nexport const output = "/coscene_script/";\n\nexport default function script(event: Input<"/foo_marker">, globalVars: GlobalVariables): Output {\n  if (event.message.id === globalVars.someNumericaVar) {\n    // Message\'s id matches $someNumericaVar\n  }\n\n  return { data: [] };\n}\n'})}),"\n",(0,r.jsx)(t.h3,{id:"debugging",children:"Debugging"}),"\n",(0,r.jsx)(t.p,{children:"User scripts are not executed unless the output topic is being used somewhere within your layout."}),"\n",(0,r.jsxs)(t.p,{children:["To debug your script, first add a Raw Messages panel subscribing to the output topic to your layout. From there, you can either inspect the incoming topic directly, or invoke ",(0,r.jsx)(t.code,{children:"log(someValue)"})," throughout the user script to print values to the Logs section at the bottom of the panel."]}),"\n",(0,r.jsxs)(t.p,{children:["The only value you cannot ",(0,r.jsx)(t.code,{children:"log()"})," is one that is, or contains, a function definition. You can also log multiple values at once, e.g. ",(0,r.jsx)(t.code,{children:"log(someValue, anotherValue, yetAnotherValue)"}),"."]}),"\n",(0,r.jsx)(t.p,{children:"The following log statements will not produce any errors:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-typescript",children:'const addNums = (a: number, b: number): number => a + b;\nlog(50, "ABC", null, undefined, { abc: 2, def: false });\nlog(1 + 2, addNums(1, 2));\n'})}),"\n",(0,r.jsx)(t.p,{children:"But these containing function definitions will:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-typescript",children:"log(() => {});\nlog(addNums);\nlog({ subtractNums: (a: number, b: number): number => a - b });\n"})}),"\n",(0,r.jsxs)(t.p,{children:["Invoking ",(0,r.jsx)(t.code,{children:"log()"})," outside your ",(0,r.jsx)(t.code,{children:"script"})," function will invoke it once, when your script is registered. Invoking ",(0,r.jsx)(t.code,{children:"log()"})," inside your ",(0,r.jsx)(t.code,{children:"script"})," function will log that value every time your ",(0,r.jsx)(t.code,{children:"script"})," function is called."]}),"\n",(0,r.jsxs)(t.blockquote,{children:["\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.strong,{children:"Tip"})}),"\n",(0,r.jsxs)(t.p,{children:["For topics publishing at a high rate, using ",(0,r.jsx)(t.code,{children:"log()"})," can slow down the user script."]}),"\n",(0,r.jsxs)(t.p,{children:["Because a Plot panel will invoke the user script across all messages in the rendered time-range, ",(0,r.jsx)(t.code,{children:"log()"})," output is not shown when plotting the output of a user script. In this case, use a Raw Messages panel to view the output message instead."]}),"\n"]}),"\n",(0,r.jsx)(t.h3,{id:"skipping-output",children:"Skipping output"}),"\n",(0,r.jsxs)(t.p,{children:["Do an early (or late) ",(0,r.jsx)(t.code,{children:"return"})," in your function body when you don't want to publish. For example, let's say you only wanted to publish messages when a constant in the input is not 3:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-typescript",children:'import { Input } from "./types";\n\nexport const inputs = ["/state"];\nexport const output = "/coscene_script/manual_metrics";\n\nexport default function script(event: Input<"/state">): { metrics: number } | undefined {\n  if (event.message.constant === 3) {\n    // Do not publish any message\n    return;\n  }\n  return {\n    // Your data here\n  };\n}\n'})}),"\n",(0,r.jsxs)(t.p,{children:["In Typescript, if you return without a value, it will implicitly return ",(0,r.jsx)(t.code,{children:"undefined"}),". Note the union return type for the ",(0,r.jsx)(t.code,{children:"script"})," function \u2013 we've indicated to Typescript that this function can return ",(0,r.jsx)(t.code,{children:"undefined"}),"."]}),"\n",(0,r.jsx)(t.h3,{id:"using-foxgloveschemas",children:"Using @foxglove/schemas"}),"\n",(0,r.jsxs)(t.p,{children:["Import and use types from the ",(0,r.jsx)(t.a,{href:"https://github.com/foxglove/foxglove-sdk",children:"@foxglove/schemas"})," package in user scripts:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-typescript",children:'import { Input } from "./types";\nimport { Color } from "@foxglove/schemas";\n\nexport const inputs = ["/imu"];\nexport const output = "/s_script/json_data";\n\nexport default function script(event: Input<"/imu">): Color {\n  return {\n    r: 1,\n    g: 1,\n    b: 1,\n    a: 1,\n  };\n}\n'})}),"\n",(0,r.jsx)(t.h2,{id:"utilities-and-templates",children:"Utilities and templates"}),"\n",(0,r.jsxs)(t.p,{children:['The sidebar\'s "Utilities" tab includes functions that can be imported for use in any script (e.g. ',(0,r.jsx)(t.code,{children:'import { compare } from "./time.ts"'}),"). The ",(0,r.jsx)(t.code,{children:"types.ts"})," utility file is generated from the currently loaded data source, and contains type definitions for all found schemas."]}),"\n",(0,r.jsx)(t.p,{children:"We currently do not allow importing 3rd-party packages, but let us know if there are packages that would be useful to you!"}),"\n",(0,r.jsxs)(t.p,{children:["The Templates tab includes boilerplate for writing common scripts, like one that publishes a ",(0,r.jsx)(t.code,{children:"MarkerArray"}),". If you have any other use cases that would work well as a template, please let us know."]}),"\n",(0,r.jsx)(t.h2,{id:"settings",children:"Settings"}),"\n",(0,r.jsxs)(t.table,{children:[(0,r.jsx)(t.thead,{children:(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.th,{children:"General"}),(0,r.jsx)(t.th,{})]})}),(0,r.jsx)(t.tbody,{children:(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:"Auto-format on save"}),(0,r.jsx)(t.td,{children:"Auto-format the code in your script on save"})]})})]}),"\n",(0,r.jsx)(t.h2,{id:"controls-and-shortcuts",children:"Controls and shortcuts"}),"\n",(0,r.jsxs)(t.p,{children:["Press ",(0,r.jsx)(t.code,{children:"Cmd"})," + ",(0,r.jsx)(t.code,{children:"s"})," to save script changes."]}),"\n",(0,r.jsx)(t.h2,{id:"typescript-resources",children:"TypeScript Resources"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"https://www.typescriptlang.org/docs/handbook/2/basic-types.html",children:"Basic Types"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"https://basarat.gitbook.io/typescript/getting-started/why-typescript",children:"Gitbook"})}),"\n"]}),"\n",(0,r.jsx)(t.h2,{id:"when-to-use-a-user-script-or-a-topic-converter-extension",children:"When to use a user script or a topic converter extension"}),"\n",(0,r.jsxs)(t.p,{children:["User scripts and ",(0,r.jsx)(t.a,{href:"/docs/viz/extensions/introduction#message-converters",children:"topic converter extensions"})," have similar capabilities, but there are key differences in how they are authored, shared, and how they support third-party packages."]}),"\n",(0,r.jsxs)(t.table,{children:[(0,r.jsx)(t.thead,{children:(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.th,{}),(0,r.jsx)(t.th,{children:"User scripts"}),(0,r.jsx)(t.th,{children:"Topic converters"})]})}),(0,r.jsxs)(t.tbody,{children:[(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:"Data transformation"}),(0,r.jsx)(t.td,{children:"\u2705"}),(0,r.jsx)(t.td,{children:"\u2705"})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:"Create new topics"}),(0,r.jsx)(t.td,{children:"\u2705"}),(0,r.jsx)(t.td,{children:"\u2705"})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:"Edit directly"}),(0,r.jsx)(t.td,{children:"\u2705"}),(0,r.jsx)(t.td,{children:"\u274C"})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:"Scoped to a layout"}),(0,r.jsx)(t.td,{children:"\u2705"}),(0,r.jsx)(t.td,{children:"\u274C"})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:"Reusable across layouts"}),(0,r.jsx)(t.td,{children:"\u274C"}),(0,r.jsx)(t.td,{children:"\u2705"})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:"Shareable with your team"}),(0,r.jsx)(t.td,{children:"\u274C"}),(0,r.jsx)(t.td,{children:"\u2705"})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:"Written in your IDE"}),(0,r.jsx)(t.td,{children:"\u274C"}),(0,r.jsx)(t.td,{children:"\u2705"})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:"Part of your codebase"}),(0,r.jsx)(t.td,{children:"\u274C"}),(0,r.jsx)(t.td,{children:"\u2705"})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:"Use third-party packages"}),(0,r.jsx)(t.td,{children:"\u274C"}),(0,r.jsx)(t.td,{children:"\u2705"})]})]})]})]})}function p(e={}){let{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},81659:function(e,t,s){s.d(t,{R:()=>o,x:()=>c});var n=s(58101);let r={},i=n.createContext(r);function o(e){let t=n.useContext(i);return n.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function c(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),n.createElement(i.Provider,{value:t},e.children)}}}]);